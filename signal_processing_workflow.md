# Foosball 声音定位系统 - 信号处理工作流程

## 系统架构概览

```
音频输入 → 信号处理 → 特征提取 → 映射转换 → 输出控制
```

## 详细工作流程

### 1. 音频输入层
```
BlackHole 16ch 设备
├── 6个立体声通道 (12个单声道)
│   ├── 通道 1-2: 左上角麦克风
│   ├── 通道 3-4: 右上角麦克风  
│   ├── 通道 5-6: 左下角麦克风
│   ├── 通道 7-8: 右下角麦克风
│   ├── 通道 9-10: 上中点麦克风
│   └── 通道 11-12: 下中点麦克风
└── 2个球门麦克风
    ├── 通道 13: 左球门
    └── 通道 14: 右球门
```

### 2. 信号处理层
```
音频采集 (AudioStream)
├── 采样率: 44100 Hz
├── 采样时长: 0.1秒
├── 数据格式: (channels, samples)
└── 输出: 原始音频数据
```

### 3. 特征提取层
```
RMS计算 (compute_rms)
├── 立体声合并: (L + R) / 2
├── RMS公式: √(Σx²/n)
├── 输出: 6个通道的RMS值
└── 球门检测: 2个球门RMS值
```

### 4. 响度映射层
```
映射函数 (map_intensity_to_0_100)
├── 分段映射策略:
│   ├── 极小值 (<0.001): 指数放大
│   ├── 小值 (0.001-0.01): 幂函数映射
│   ├── 中等值 (0.01-0.1): 分段线性映射
│   └── 大值 (>0.1): 高对比度映射
├── 通道差异放大: 27-38倍
└── 输出: 0-100范围的映射响度
```

### 5. BPM计算层
```
TempoMapper
├── 强度计算:
│   ├── 加权平均RMS
│   ├── RMS变化率
│   └── 综合强度指标
├── BPM映射:
│   ├── 基础BPM: 140
│   ├── 最大BPM: 200
│   ├── 最小BPM: 100
│   └── 平滑过渡算法
└── 输出: 实时BPM值
```

### 6. 位置估计层
```
声源定位 (estimate_position)
├── 输入: 6个通道的映射响度
├── 算法: 响度加权重心法
├── 权重计算: w = rms / Σrms
└── 输出: (x, y) 坐标
```

### 7. 进球检测层
```
进球检测 (detect_goals)
├── 输入: 球门麦克风RMS值
├── 阈值检测: >0.3
├── 输出: [左球门进球, 右球门进球]
└── 状态: 0/1 布尔值
```

### 8. 输出控制层
```
OSC通信 (OSCSender)
├── 目标: Max/MSP
├── 地址: /foosball_status
├── 数据包:
│   ├── 映射响度: [6个通道]
│   ├── 位置坐标: (x, y)
│   ├── 进球状态: [左, 右]
│   └── BPM值: 实时BPM
└── 频率: 10Hz (0.1秒间隔)
```

## 数据流图

```
音频输入 → 预处理 → RMS计算 → 响度映射 → BPM计算
    ↓         ↓         ↓         ↓         ↓
  原始数据   立体声合并  特征提取   差异放大   节奏控制
    ↓         ↓         ↓         ↓         ↓
位置估计 ← 进球检测 ← 球门处理 ← 响度映射 ← 强度计算
    ↓         ↓
 OSC输出 → Max/MSP
```

## 关键参数配置

### 音频参数
- 采样率: 44100 Hz
- 通道数: 14 (12立体声 + 2球门)
- 采样时长: 0.1秒
- 设备: BlackHole 16ch

### 映射参数
- 静音阈值: 0.0001
- 映射范围: 0-100
- 差异放大: 27-38倍
- 响应速度: 高对比度

### BPM参数
- 基础BPM: 140
- 最大BPM: 200
- 最小BPM: 100
- 上升速率: 0.2
- 下降速率: 0.02

### 定位参数
- 麦克风布局: 6个定位点
- 算法: 响度加权重心
- 坐标系统: 厘米单位
- 更新频率: 10Hz

## 系统特点

1. **实时处理**: 100ms延迟
2. **高精度映射**: 通道差异放大
3. **平滑过渡**: BPM渐变算法
4. **多通道支持**: 14通道输入
5. **模块化设计**: 独立功能模块
6. **OSC通信**: 标准协议输出

## 应用场景

- 音乐互动装置
- 游戏控制器
- 声音可视化
- 实时音乐生成
- 多媒体艺术项目 