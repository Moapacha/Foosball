# Foosball 声音定位系统

一个基于声音定位的桌面足球游戏系统，使用8个麦克风阵列进行实时位置估计和进球检测。

## 功能特点

- **实时声音定位**: 使用6个麦克风阵列进行声源位置估计
- **进球检测**: 使用2个球门麦克风检测进球事件
- **BPM映射**: 实时计算和映射音频响度到BPM值
- **-10到10映射**: 将音频强度映射到-10到10范围，确保变化幅度明显
- **双OSC输出**: 支持独立的主状态端口和位置估计端口
- **模拟测试**: 提供完整的音频模拟测试功能
- **蓝方vs红方**: 支持蓝方(左) vs 红方(右)的对战布局

## 麦克风配置

系统使用8个麦克风：
- **球门麦克风** (通道1-2): 进球检测
  - 通道1: 左门 (-10, 34) - 蓝方球门
  - 通道2: 右门 (127, 34) - 红方球门
- **定位麦克风** (通道3-8): 桌面位置估计
  - 通道3: 左下 (0, 0) - 蓝方
  - 通道4: 左上 (0, 68) - 蓝方
  - 通道5: 中下 (58.5, 0)
  - 通道6: 中上 (58.5, 68)
  - 通道7: 右下 (117, 0) - 红方
  - 通道8: 右上 (117, 68) - 红方

## 坐标系

- **坐标系**: 左下(0,0), 右上(117,68)
- **布局**: 蓝方(左) vs 红方(右)
- **映射**: 原始坐标映射到Spat Revolution的-1到1范围

## OSC通信配置

系统支持双OSC端口输出：

### 主状态端口 (11111)
- **OSC地址**: `/foosball_status`
- **数据格式**: `[mapped_intensity1, mapped_intensity2, mapped_intensity3, mapped_intensity4, mapped_intensity5, mapped_intensity6, x, y, goal_left, goal_right, bpm]`
- **说明**: 包含6个通道的映射响度值(0-127)、位置坐标、进球检测状态(0/127)和BPM值

### 位置估计端口 (7777)
- **OSC地址**: `/source/1/xyz`
- **数据格式**: `[x_mapped, y_mapped, 0.0]`
- **说明**: 位置坐标映射到-1到1范围，适用于Spat Revolution

## 配置文件

主要配置文件为 `mic_config.yaml`，包含：

- 麦克风位置坐标（8个麦克风）
- 音频设备配置
- OSC通信配置
- 位置估计独立OSC配置

## 使用方法

### 1. 运行主程序
```bash
python main.py
```

### 2. 运行模拟测试
```bash
python simulate_audio.py
```

### 3. 运行系统测试
```bash
python test_4channel.py
```

### 4. 测试新布局
```bash
python verify_config.py
```

### 5. 可视化布局
```bash
python visualize_layout_en.py
```

## 系统要求

- Python 3.7+
- BlackHole 16ch 音频设备
- Max/MSP 或其他OSC接收软件

## 依赖包

- numpy
- pyyaml
- python-osc
- pyaudio
- matplotlib (用于可视化)

## 安装依赖

```bash
pip install numpy pyyaml python-osc pyaudio matplotlib
```

## 注意事项

1. 确保BlackHole 16ch设备正在接收音频
2. Max/MSP需要监听两个端口：
   - 端口11111 (主状态)
   - 端口7777 (位置估计)
3. 系统使用6个定位麦克风进行位置估计，2个球门麦克风进行进球检测
4. 球门麦克风从BlackHole的通道1-2输入，定位麦克风从通道3-8输入
5. 新布局支持蓝方(左) vs 红方(右)的对战模式
6. 坐标系已重新规整：左下(0,0), 右上(117,68)

## 布局说明

- **蓝方区域**: 左侧 (x < 58.5)
- **红方区域**: 右侧 (x > 58.5)
- **中场线**: x = 58.5
- **球门位置**: 左门(-10,34), 右门(127,34)
- **通道映射**: 1左门, 2右门, 3左下, 4左上, 5中下, 6中上, 7右下, 8右上